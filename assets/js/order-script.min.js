jQuery((function(e){function t(t,d=null){t.find(".read-only").is(":visible")?("notes"===d?t.find(".editable-notes :input").attr("disabled",!1):(t.find(".editable").show(),t.find(":input").attr("disabled",!1)),t.find(".read-only").hide(),t.find(".editable-notes").show(),t.closest(".wcpdf-data-fields").find(".wpo-wcpdf-document-buttons").show(),e(".wcpdf-data-fields .woocommerce-help-tip").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200,keepAlive:!0}).css("cursor","help"),e(".wcpdf-data-fields .date-picker-field, .date-picker").datepicker({dateFormat:"yy-mm-dd",numberOfMonths:1,showButtonPanel:!0})):(t.find(".read-only").show(),t.find(".editable").hide(),t.find(".editable-notes").hide(),t.find(":input").attr("disabled",!0),t.closest(".wcpdf-data-fields").find(".wpo-wcpdf-document-buttons").hide())}let d;e("#doaction, #doaction2").on("click",(function(t){let d=e(this).attr("id").substr(2),a=e('select[name="'+d+'"]').val();if(-1!==e.inArray(a,wpo_wcpdf_ajax.bulk_actions)){t.preventDefault();let d=a,o=[],n=!1;if(-1!=a.indexOf("xml")&&(d=d.replace("_xml",""),n=!0),e('tbody th.check-column input[type="checkbox"]:checked').each((function(){o.push(e(this).val())})),!o.length)return void alert(wpo_wcpdf_ajax.select_orders);let i="",c="";if(i=-1!=wpo_wcpdf_ajax.ajaxurl.indexOf("?")?wpo_wcpdf_ajax.ajaxurl+"&action=generate_wpo_wcpdf&document_type="+d+"&bulk&_wpnonce="+wpo_wcpdf_ajax.nonce:wpo_wcpdf_ajax.ajaxurl+"?action=generate_wpo_wcpdf&document_type="+d+"&bulk&_wpnonce="+wpo_wcpdf_ajax.nonce,n)e.each(o,(function(e,t){c=i+"&order_ids="+t+"&output=xml",window.open(c,"_blank")}));else{let e=o.join("x");c=i+"&order_ids="+e,window.open(c,"_blank")}}})),wpo_wcpdf_ajax.sticky_document_data_metabox&&e("#wpo_wcpdf-data-input-box").insertAfter("#woocommerce-order-data"),e("#wpo_wcpdf-data-input-box").on("click",".wpo-wcpdf-set-date-number, .wpo-wcpdf-edit-date-number, .wpo-wcpdf-edit-document-notes",(function(){let d=e(this).closest(".wcpdf-data-fields-section");0==d.length&&(d=e(this).closest(".wcpdf-data-fields")),t(d,e(this).data("edit"))})),e("#wpo_wcpdf-data-input-box").on("click",".wpo-wcpdf-cancel",(function(){t(e(this).closest(".wcpdf-data-fields"))})),e("#wpo_wcpdf-data-input-box").on("click",".wpo-wcpdf-save-document, .wpo-wcpdf-regenerate-document, .wpo-wcpdf-delete-document",(function(d){d.preventDefault();let a=e(this).closest(".wcpdf-data-fields"),o=e(this).data("action"),n=e(this).data("nonce"),i=a.data(),c=a.find(":input:visible:not(:disabled)").serialize();if("regenerate"===o){if(!1===window.confirm(wpo_wcpdf_ajax.confirm_regenerate))return;a.find(".wpo-wcpdf-regenerate-document").addClass("wcpdf-regenerate-spin")}else if("delete"===o){if(!1===window.confirm(wpo_wcpdf_ajax.confirm_delete))return;a.find(".wpo-wcpdf-regenerate-document").hide()}const p=e(this).closest("#wpo_wcpdf-data-input-box").find(".notice");p.length&&p.remove(),a.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),e.ajax({url:wpo_wcpdf_ajax.ajaxurl,data:{action:"wpo_wcpdf_"+o+"_document",security:n,form_data:c,order_id:i.order_id,document_type:i.document,action_type:o,wpcdf_document_data_notice:o+"d"},type:"POST",context:a,success:function(d){a.closest("#wpo_wcpdf-data-input-box").load(document.URL+" #wpo_wcpdf-data-input-box .postbox-header, #wpo_wcpdf-data-input-box .inside",(function(){t(a);const n=d.success?"success":"error",c=e(this).find('.wcpdf-data-fields[data-document="'+i.document+'"][data-order_id="'+i.order_id+'"]');c.length&&c.before('<div class="notice notice-'+n+' inline" style="margin:0 10px 10px 10px;"><p>'+d.data.message+"</p></div>"),"regenerate"===o&&(a.find(".wpo-wcpdf-regenerate-document").removeClass("wcpdf-regenerate-spin"),t(a)),a.unblock()}))}})})),e("#wpo_wcpdf-data-input-box").on("click",".view-more, .hide-details",(function(t){t.preventDefault(),e(this).hide(),e(".pdf-more-details").slideToggle("slow"),e(this).hasClass("view-more")?e(".hide-details").show():e(".view-more").show()})),e(document).on("input",".wcpdf-data-fields input",(function(){const t=e(this).closest(".wcpdf-data-fields");clearTimeout(d),d=setTimeout((()=>{!function(t){let d=t.find('input[name$="_number_prefix"]').val(),a=t.find('input[name$="_number_suffix"]').val(),o=t.find('input[name$="_number_padding"]').val(),n=t.find('input[name$="_number_plain"]').val(),i=t.data("document"),c=t.data("order_id");e.ajax({url:wpo_wcpdf_ajax.ajaxurl,method:"POST",data:{action:"wpo_wcpdf_preview_formatted_number",security:wpo_wcpdf_ajax.nonce,prefix:d,suffix:a,padding:o,plain:n,document:i,order_id:c},success:function(e){if(e.success&&e.data.formatted){let d=t.find(".formatted-number"),a=d.data("current"),o=e.data.formatted;d.val(o),a!==o?d.addClass("changed"):d.removeClass("changed")}},error:function(e,d,a){console.error("AJAX error:",d,a),t.find(".formatted-number").value(wpo_wcpdf_ajax.error_loading_number_preview)}})}(t)}),300)}));const a="#wpo_ips-edi-box .edi-customer-identifiers";e(document.body).on("click",a+" td.collapse > a",(function(t){t.preventDefault();let d=e(this),a=d.closest("table").find("tbody");a.is(":visible")?(a.slideUp("fast"),d.text(wpo_wcpdf_ajax.edi_metabox.show)):(a.slideDown("fast"),d.text(wpo_wcpdf_ajax.edi_metabox.hide))}));const o=`${a}.peppol`;e(document.body).on("click",o+" thead .editable a",(function(t){t.preventDefault(),e(this).closest("table").addClass("is-editing")})),e(document.body).on("click",o+" tfoot .button.cancel",(function(t){t.preventDefault(),e(this).closest("table").removeClass("is-editing")})),e(document.body).on("click",o+" tfoot .button-primary",(function(t){t.preventDefault();const d=e(this),a=d.data("order_id"),n=d.closest("table"),i=n.closest(o),c=i.find('tbody input[type="text"]').serializeArray(),p={};e.each(c,(function(e,t){p[t.name]=t.value}));const s={action:"wpo_ips_edi_save_order_customer_peppol_identifiers",security:wpo_wcpdf_ajax.nonce,order_id:a,values:p};d.prop("disabled",!0),e.post(wpo_wcpdf_ajax.ajaxurl,s).done((function(t){i.find("tbody tr").each((function(){const t=e(this),d=t.find('td.edit input[type="text"]').val();t.find("td.display").text(d||"â€”")})),n.removeClass("is-editing");const d=t&&t.data&&t.data.message||wpo_wcpdf_ajax.saved;window.wp&&wp.a11y&&wp.a11y.speak?wp.a11y.speak(d):alert(d)})).fail((function(e){const t=e.responseJSON&&e.responseJSON.data&&e.responseJSON.data.message||wpo_wcpdf_ajax.fail;alert(t)})).always((function(){d.prop("disabled",!1)}))}))}));
