jQuery((function(e){e(".wcpdf-extensions .more").hide(),e(".wcpdf-extensions > li").on("click",(function(t){e(this).toggleClass("expanded"),e(this).find(".more").slideToggle()})),e(".edit-next-number").on("click",(function(t){e(this).hide(),e(this).siblings("input").prop("disabled",!1),e(this).siblings(".save-next-number.button").show()})),e(".save-next-number").on("click",(function(t){$input=e(this).siblings("input"),$input.addClass("ajax-waiting");let a=$input.val();if(a.length>0&&a>2147483647)return alert(wpo_wcpdf_admin.mysql_int_size_limit),void $input.removeClass("ajax-waiting");let i={security:$input.data("nonce"),action:"wpo_wcpdf_set_next_number",store:$input.data("store"),number:a};xhr=e.ajax({type:"POST",url:wpo_wcpdf_admin.ajaxurl,data:i,success:function(e){$input.removeClass("ajax-waiting"),$input.siblings(".edit-next-number").show(),$input.prop("disabled","disabled"),$input.siblings(".save-next-number.button").hide()}})})),e("[name='wpo_wcpdf_documents_settings_invoice[display_number]']").on("change",(function(t){"order_number"==e(this).val()?(e(this).closest("td").find(".description").slideDown(),e(this).closest("tr").nextAll("tr").has("input#next_invoice_number").first().hide()):(e(this).closest("td").find(".description").hide(),e(this).closest("tr").nextAll("tr").has("input#next_invoice_number").first().show())})).trigger("change"),e(".wcpdf_document_settings_sections > h2").on("click",(function(){e(this).parent().find("ul").toggleClass("active")})),e.each(wpo_wcpdf_admin.pointers,(function(t,a){e(a.target).pointer({content:a.content,position:{edge:a.position.edge,align:a.position.align},pointerClass:a.pointer_class,pointerWidth:a.pointer_width,close:function(){jQuery.post(wpo_wcpdf_admin.ajaxurl,{pointer:t,action:"dismiss-wp-pointer"})}}),-1===e.inArray(t,wpo_wcpdf_admin.dismissed_pointers.split(","))&&e(a.target).pointer("open")})),e(".woocommerce-help-tip").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:200}),e("#wpo-wcpdf-preview-wrapper #due_date").on("change",(function(){const t=e("#wpo-wcpdf-preview-wrapper #due_date"),a=e("#wpo-wcpdf-preview-wrapper #due_date_days");t.is(":checked")?a.prop("disabled",!1):a.prop("disabled",!0)})).trigger("change");let t,a,i,s,n,r,d,o,p=e("#wpo-wcpdf-preview-wrapper"),c=e("#wpo-wcpdf-preview-wrapper .preview"),l=e('#wpo-wcpdf-preview-wrapper input[name="order_id"]'),w=e('#wpo-wcpdf-preview-wrapper input[name="document_type"]'),u=e('#wpo-wcpdf-preview-wrapper input[name="output_format"]'),f=e('#wpo-wcpdf-preview-wrapper input[name="nonce"]'),h=e("#wpo-wcpdf-settings"),v=null;function m(){t=l.val(),a=w.val(),i=u.val(),s=f.val(),n=h.serialize()}function g(){l.val("").trigger("change")}function _(){0==p.attr("data-preview-states-lock")&&(e(this).width()<=1200&&(o>1200||e(this).width()==o)?"full"==p.attr("data-preview-state")?(p.find(".preview-document").show(),p.find(".sidebar").hide(),p.find(".slide-left").hide(),p.find(".slide-right").show(),p.attr("data-preview-states",2),p.attr("data-preview-state","full"),p.attr("data-from-preview-state","")):(p.find(".preview-document").hide(),p.find(".sidebar").show(),p.find(".slide-left").show(),p.find(".slide-right").hide(),p.attr("data-preview-states",2),p.attr("data-preview-state","closed"),p.attr("data-from-preview-state","")):e(this).width()>1200&&(o<=1200||e(this).width()==o)&&("full"==p.attr("data-preview-state")?(p.find(".preview-document").show(),p.find(".sidebar").hide(),p.find(".slide-left").hide(),p.find(".slide-right").show(),p.attr("data-preview-states",3),p.attr("data-preview-state","full"),p.attr("data-from-preview-state","sidebar"),p.addClass("static")):"closed"==p.attr("data-preview-state")&&e(this).width()!==o?(p.find(".preview-document").hide(),p.find(".sidebar").show(),p.find(".slide-left").show(),p.find(".slide-right").hide(),p.attr("data-preview-states",3),p.attr("data-preview-state","closed"),p.attr("data-from-preview-state",""),p.removeClass("static")):(p.find(".preview-document, .sidebar").show(),p.find(".slide-left, .slide-right").show(),p.attr("data-preview-states",3),p.attr("data-preview-state","sidebar"),p.attr("data-from-preview-state",""),p.removeClass("static")))),o=e(this).width()}function b(e){window.scrollTo(0,0);let t=e;setTimeout((function(){t.addClass("static")}),300)}function y(t,a){"shop_address_country"===t.target.id&&x(e(t.target)),k();let i=e(t.target);if(!function(t){let a=!1;if(!t)return a;let i=t.includes("[")?t.match(/\[(.*?)\]/)[1]:t;-1!==e.inArray(i,wpo_wcpdf_admin.preview_excluded_settings)&&(a=!0);return a}(i.attr("name"))){if(i.hasClass("remove-requirement")||"disable_for"==i.attr("id"))return;if(-1!==e.inArray(t.type,["keyup","paste"])){if(i.is('input[type="checkbox"], select'))return;a="keyup"==t.type?1e3:0}C(a)}}function x(t){const a=t.val(),i=t.closest("form"),s=t.attr("name").match(/\[shop_address_country]\[(.*?)\]/),n=s?s[1]:"default",r=i.find(`select[name="wpo_wcpdf_settings_general[shop_address_state][${n}]"]`),d=r.closest(".wpo-wcpdf-input-wrapper").find("#shop_address_state_action");return r.empty().prop("disabled",!0),d.prop("disabled",!0),r.append(e("<option>",{value:"",text:wpo_wcpdf_admin.shop_country_changed_messages.loading})),e.ajax({url:wpo_wcpdf_admin.ajaxurl,type:"POST",dataType:"json",data:{action:"wcpdf_get_country_states",country:a},success:function(t){r.empty();const a=t.data?.states,i=t.data?.selected;t.success&&a&&Object.keys(a).length>0?(e.each(a,(function(t,a){r.append(e("<option>",{value:t,text:a,selected:t===i}))})),r.prop("disabled",!1),d.prop("disabled",!1)):r.append(e("<option>",{value:"",text:wpo_wcpdf_admin.shop_country_changed_messages.empty})),C()},error:function(){r.empty().append(e("<option>",{value:"",text:wpo_wcpdf_admin.shop_country_changed_messages.error})),C()}})}function k(t){e(".preview-data-wrapper .save-settings p").css("margin-right","0")}function C(d=0){$previewStates=e("#wpo-wcpdf-preview-wrapper").data("preview-states"),"undefined"!==$previewStates&&1!==$previewStates&&(d="number"==typeof d?d:0,m(),clearTimeout(r),r=setTimeout((function(){!function(){console.log("Loading preview...");let r=wpo_wcpdf_admin.pdfjs_worker,d="preview-canvas",o={action:"wpo_wcpdf_preview",security:s,order_id:t,document_type:a,output_format:i,data:n};c.children(".notice").remove(),c.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),v=e.ajax({type:"POST",url:wpo_wcpdf_admin.ajaxurl,data:o,beforeSend:function(e,t){null!=v&&v.abort()},success:function(t,a,i){if(t.data.error)e("#"+d).remove(),c.append('<div class="notice notice-error inline"><p>'+t.data.error+"</p></div>");else if(t.data.preview_data&&t.data.output_format)switch(e("#"+d).remove(),t.data.output_format){default:case"pdf":c.append('<canvas id="'+d+'" style="width:100%;"></canvas>'),function(e,t,a){a=window.atob(a),pdfjsLib.GlobalWorkerOptions.workerSrc=e,pdfjsLib.getDocument({data:a}).promise.then((function(e){let a=1;e.getPage(a).then((function(e){let a=2,i=e.getViewport({scale:a}),s=document.getElementById(t),n=s.getContext("2d");s.height=i.height,s.width=i.width;let r={canvasContext:n,viewport:i};e.render(r).promise.then((function(){}))}))}),(function(e){console.error(e)}))}(r,d,t.data.preview_data);break;case"xml":{const a=t.data.preview_data.replace(/\s+(xmlns(?::[\w.-]+)?=)/g,"\n $1"),i=e("<code>",{class:"language-xml"}).text(a);c.empty().append(e("<pre>").append(i)),Prism.highlightElement(i[0]);break}}c.unblock()},error:function(t,a,i){if("abort"!=a){let a=t.status+": "+t.statusText;e("#"+d).remove(),c.append('<div class="notice notice-error inline"><p>'+a+"</p></div>"),c.unblock()}}})}()}),d))}w.val(w.data("default")).trigger("change"),g(),m(),o=e(window).width(),_(),e(window).on("resize",_),e(".slide-left").on("click",(function(){let e=p.attr("data-preview-states"),t=p.attr("data-preview-state");p.find(".preview-data-wrapper ul").removeClass("active"),3==e?"closed"==t?(p.find(".preview-document").show(),p.find(".slide-right").show(),p.attr("data-preview-state","sidebar"),p.attr("data-from-preview-state","closed")):(p.find(".slide-left").hide(),p.find(".sidebar").delay(300).hide(0),p.attr("data-preview-state","full"),p.attr("data-from-preview-state","sidebar"),b(p)):(p.find(".preview-document").show(),p.find(".slide-left").hide(),p.find(".slide-right").show(),p.attr("data-preview-state","full"),p.attr("data-from-preview-state","closed"),b(p))})),e(".slide-right").on("click",(function(){let e=p.attr("data-preview-states"),t=p.attr("data-preview-state");p.find(".preview-data-wrapper ul").removeClass("active"),3==e?"full"==t?(p.find(".slide-left").delay(400).show(0),p.find(".sidebar").show(),p.attr("data-preview-state","sidebar"),p.attr("data-from-preview-state","full")):(p.find(".preview-document").hide(300),p.find(".slide-right").hide(),p.attr("data-preview-state","closed"),p.attr("data-from-preview-state","sidebar")):(p.find(".preview-document").hide(300),p.find(".slide-left").show(),p.find(".slide-right").hide(),p.attr("data-preview-state","closed"),p.attr("data-from-preview-state","full")),p.removeClass("static")})),e(".preview-document .preview-data p").on("click",(function(){let t=e(this).closest(".preview-data");t.siblings(".preview-data").find("ul").removeClass("active"),t.find("ul").toggleClass("active")})),e(".preview-document .preview-data ul > li").on("click",(function(){let t=e(this).closest(".preview-data");t.find("ul").toggleClass("active"),e(this).hasClass("order-search")?(t.find("p.last-order").hide(),t.find('input[name="preview-order-search"]').addClass("active"),t.find("p.order-search").show().find(".order-search-label").text(e(this).text())):(t.find("p.last-order").show(),t.find("p.order-search").hide(),t.find('input[name="preview-order-search"]').removeClass("active").val(""),t.find("#preview-order-search-results").hide(),t.find("img.preview-order-search-clear").hide(),g(),C())})),C(),e(document).on("wpo-wcpdf-settings-changed",(function(e,t){k(),C(t)})),e(document).on("wpo-wcpdf-refresh-preview wpo_wcpdf_refresh_preview",(function(e,t){C(t)})),e(document).on("click","#preview-order-search-results a",(function(t){t.preventDefault(),e(".preview-document .order-search-label").text("#"+e(this).data("order_id")),l.val(e(this).data("order_id")).trigger("change"),e(this).closest("div").hide(),e(this).closest("div").children("a").remove(),C()})),e(document).on("keyup paste","#wpo-wcpdf-settings input, #wpo-wcpdf-settings textarea",y),e(document).on("change",'#wpo-wcpdf-settings input[type="checkbox"], #wpo-wcpdf-settings input[type="radio"], #wpo-wcpdf-settings select',(function(e){"shop_address_country"!==e.target.id&&e.isTrigger||y(e)})),e(document).on("select2:select select2:unselect","#wpo-wcpdf-settings select.wc-enhanced-select",y),e(document.body).on("wpo-wcpdf-media-upload-setting-updated",y),e(document).on("click",".wpo_remove_image_button, #wpo-wcpdf-settings .remove-requirement",y),e("#wpo_wcpdf_settings_general-shop_address_country-translations").length>0&&e('#wpo-wcpdf-settings select[name^="wpo_wcpdf_settings_general[shop_address_country]"]').each((function(){const t=e(this);t.val()&&x(t)})),e(document.body).on("click",".preview-data-wrapper .save-settings p input",(function(t){e("#wpo-wcpdf-settings input#submit").trigger("click")})),e(document).on("click","img.preview-order-search-clear",(function(t){t.preventDefault(),e(this).closest("div").find("input#preview-order-search").val(""),e(this).closest(".preview-data").find("#preview-order-search-results").children("a").remove(),e(this).closest(".preview-data").find("#preview-order-search-results").children(".error").remove(),e(this).closest(".preview-data").find("#preview-order-search-results").hide(),e(this).hide()})),e("#wpo-wcpdf-preview-wrapper ul.preview-data-option-list li").on("click",(function(){let t=e(this).closest("ul").data("input-name");e("#wpo-wcpdf-preview-wrapper :input[name="+t+"]").val(e(this).data("value")).trigger("change")})),w.on("change",(function(){let t=e(this).val();if(t.length){let a=e(this).attr("name"),i=e("#wpo-wcpdf-preview-wrapper ul.preview-data-option-list[data-input-name="+a+"]"),s=i.find("li[data-value="+t+"]");i.parent().find(".current-label").text(s.text()),C()}})).trigger("change"),l.on("change",(function(){C()})).trigger("change"),e("#preview-order-search").on("keyup paste",(function(t){let i=e(this);i.addClass("ajax-waiting");let s="keyup"==t.type?1e3:0;m(),clearTimeout(d),d=setTimeout((function(){!function(t){let i=t.closest(".preview-data").find("#preview-order-search-results"),s=t.val(),n=t.data("nonce"),r={security:n,action:"wpo_wcpdf_preview_order_search",search:s,document_type:a};i.parent().find("img.preview-order-search-clear").hide(),i.children(".error").remove(),i.children("a").remove(),i.hide(),e.ajax({type:"POST",url:wpo_wcpdf_admin.ajaxurl,data:r,success:function(a){a.data&&(a.data.error?(i.append('<span class="error">'+a.data.error+"</span>"),i.show()):e.each(a.data,(function(e,t){let a='<a data-order_id="'+e+'"><span class="order-number">#'+t.order_number+"</span> - "+t.billing_first_name+" "+t.billing_last_name;t.billing_company.length>0&&(a=a+", "+t.billing_company);let s='<br><span class="date">'+t.date_created+'</span><span class="total">'+t.total+"</span></a>";i.append(a+s),i.show()}))),t.removeClass("ajax-waiting"),t.closest("div").find("img.preview-order-search-clear").show()}})}(i)}),s)})),function(){const t=new URLSearchParams(window.location.search).get("tab")||"general";if(!["general","documents"].includes(t))return;e(".settings_category").not("#"+{general:"display",documents:"general"}[t]).find(".form-table").hide();const a=e(".settings_category h2");a.each((function(a){const i="true"===localStorage.getItem(`wcpdf_${t}_settings_accordion_state_${a}`);e(this).toggleClass("active",i).next(".form-table").toggle(i)})),a.on("click",(function(){const i=a.index(this);e(this).toggleClass("active").next(".form-table").slideToggle("fast",(function(){localStorage.setItem(`wcpdf_${t}_settings_accordion_state_${i}`,e(this).is(":visible"))}))}))}();const $=new Set;function j(t){const a=e(t.target);let i=a.prop("name").replace("[]",""),s=a.val(),n=!1;a.is(":checkbox")&&(s=a.is(":checked"),n=!0),e("[data-show_for_option_name='"+i+"']").each((function(){let t=!1,a=e(this).data("show_for_option_values");t=n?s:Array.isArray(s)?s.some((e=>a.includes(e))):a.includes(s);let i=e(this).closest("tr");t?(i.show(),n&&i.find(":input[type=checkbox]").val("1")):i.hide().find(":input").each((function(){const t=e(this);t.is("select")?t.prop("multiple")?t.val([]):t.prop("selectedIndex",0):t.is(":checkbox")?t.prop("checked",!1):t.val(""),t.trigger("change")}))}))}e("[data-show_for_option_name]").each((function(){const t=e(this).data("show_for_option_name");$.has(t)||(e(document).on("change",`[name="${t}"], [name="${t}[]"]`,j),e(`[name="${t}"], [name="${t}[]"]`).each((function(){j({target:this})})),$.add(t))})),e("#wpo-wcpdf-settings .sync-address").on("click",(function(t){t.preventDefault();const a=e(this),i=e(this).closest("form"),s=a.find("span.dashicons"),n=a.closest(".wpo-wcpdf-input-wrapper").find(".sync-tooltip");let r=a.closest(".wpo-wcpdf-input-wrapper").find("input");0===r.length&&(r=a.closest(".wpo-wcpdf-input-wrapper").find("select")),s.toggleClass("rotate"),e.ajax({type:"POST",url:wpo_wcpdf_admin.ajaxurl,data:{action:"wpo_wcpdf_sync_address",security:wpo_wcpdf_admin.nonce,address_field:r.attr("id")},success:function(e){if(e.success&&e.data.value&&""!==e.data.value.trim()){if("shop_address_country"===r.attr("id")){const t=e.data.value.split(":");r.val(t[0]),x(r).done((function(){const e=r.attr("name").match(/\[([^\]]+)\]/g),a=e?e[e.length-1].replace(/[\[\]]/g,""):"default",s=i.find(`select[name="wpo_wcpdf_settings_general[shop_address_state][${a}]"]`);0!==s.length&&s.val(t[1])}))}else r.val(e.data.value);C()}else!e.success&&e.data.message&&""!==e.data.message.trim()&&(n.text(e.data.message).addClass("visible"),setTimeout((function(){n.removeClass("visible")}),3e3))},complete:function(){s.toggleClass("rotate")}})}))}));
